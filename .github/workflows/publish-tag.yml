name: Release Tags
on:
  workflow_dispatch:

jobs:
  publish-packages:
    name: Create tags for release
    permissions:
      actions: write
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/prepare
      - uses: bluefireteam/melos-action@v3
        with:
          run-bootstrap: false
      - run: |
          echo "" > .new-tags

          melos exec -c 1 ${{ (inputs.include-private == 'true' && '--private') || '--no-private' }} -- \
          bash -c '
            TAG="$MELOS_PACKAGE_NAME-v$MELOS_PACKAGE_VERSION"

            if git rev-parse --verify "$TAG" >/dev/null 2>&1; then
              echo "Tag $TAG already exists â€” skipping tag creation"
            else
              echo "Creating tag $TAG"
              git tag "$TAG"
              echo "$TAG" >> ../../.new-tags
            fi
          '

          git push --tags
      - run: |
          while IFS= read -r TAG; do
            if [ -n "$TAG" ]; then
              echo "Triggering publish-release workflow for $TAG"
              gh workflow run publish-release.yml --ref "$TAG"
            fi
          done < .new-tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
