name: Release Tags
on:
  workflow_dispatch:

jobs:
  publish-packages:
    name: Create tags for release
    permissions:
      actions: write
      contents: write
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/prepare
      - run: |
          : > .new-tags

          melos exec -c 1 --no-private -- \
          bash -c '
            set -e

            TAG="$MELOS_PACKAGE_NAME-v$MELOS_PACKAGE_VERSION"
            ROOT="$MELOS_ROOT_PATH"

            echo "Checking tag: $TAG"

            if git ls-remote --tags origin "refs/tags/$TAG" >/dev/null 2>&1; then
              echo "Remote tag $TAG already exists — skipping"
              exit 0
            fi


            if git rev-parse --verify "$TAG" >/dev/null 2>&1; then
              echo "Local tag $TAG already exists — skipping"
              exit 0
            fi

            echo "Creating tag $TAG"
            git tag "$TAG"

            echo "$TAG" >> "$ROOT/.new-tags"
          '


          if [ -s .new-tags ]; then
            echo "Pushing new tags:"
            cat .new-tags
            while IFS= read -r TAG; do
              [ -z "$TAG" ] && continue
              echo "Pushing tag: $TAG"
              git push origin "refs/tags/$TAG"
            done < .new-tags
          else
            echo "No new tags to push"
          fi

      - run: |
          if [ ! -s .new-tags ]; then
            echo "No new tags, skipping publish-release workflows"
            exit 0
          fi

          while IFS= read -r TAG; do
            [ -z "$TAG" ] && continue
            echo "Triggering publish-release.yml for tag: $TAG"
            gh workflow run publish-release.yml --ref "$TAG" \
              -f tag="$TAG"
          done < .new-tags
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
